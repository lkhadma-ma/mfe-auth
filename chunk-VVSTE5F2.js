var S=Object.defineProperty;var g=Object.getOwnPropertySymbols;var y=Object.prototype.hasOwnProperty,w=Object.prototype.propertyIsEnumerable;var p=(n,e,t)=>e in n?S(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,d=(n,e)=>{for(var t in e||={})y.call(e,t)&&p(n,t,e[t]);if(g)for(var t of g(e))w.call(e,t)&&p(n,t,e[t]);return n};var l=(n,e,t)=>new Promise((r,o)=>{var s=i=>{try{c(t.next(i))}catch(u){o(u)}},a=i=>{try{c(t.throw(i))}catch(u){o(u)}},c=i=>i.done?r(i.value):Promise.resolve(i.value).then(s,a);c((t=t.apply(n,e)).next())});import{inject as k,signal as v,effect as m}from"@angular/core";import{Auth as I,signInWithPopup as b,GoogleAuthProvider as h,signInWithCredential as A,signOut as N,authState as T}from"@angular/fire/auth";import*as f from"@angular/core";var U=class n{auth=k(I);GSI_CLIENT_ID="21675652332-t3tnud7hssn9qsmpka13evv46001nvn7.apps.googleusercontent.com";user$=T(this.auth);accounts=v(this.loadAccounts());activeUser=v(this.loadActiveUser());constructor(){m(()=>this.saveAccounts(this.accounts())),m(()=>this.saveActiveUser(this.activeUser()))}loginWithGoogle(){return l(this,null,function*(){let e=new h;e.setCustomParameters({prompt:"consent select_account",access_type:"offline"});let t=yield b(this.auth,e),r=t.user,o=h.credentialFromResult(t),s=o?JSON.stringify({idToken:o.idToken,accessToken:o.accessToken}):void 0,a={uid:r.uid,displayName:r.displayName,email:r.email,photoURL:r.photoURL,credential:s};return this.addAccount(a),this.activeUser.set(a),yield this.linkGoogleDrive(),r})}addAccount(e){let t=this.accounts().findIndex(r=>r.uid===e.uid);t>=0?this.accounts.update(r=>{let o=[...r];return o[t]=d(d({},o[t]),e),o}):this.accounts.update(r=>[...r,e])}switchAccount(e){return l(this,null,function*(){let t=this.accounts().find(r=>r.uid===e);if(!t)return Promise.reject("User not found");try{if(t.credential){let r=JSON.parse(t.credential),o=h.credential(r.idToken,r.accessToken),s=yield A(this.auth,o);return this.activeUser.set(t),s.user}}catch{console.warn("Cached credential expired, falling back to popup")}return this.loginWithGoogle()})}logout(){return this.activeUser.set(null),N(this.auth)}currentUser(){return this.activeUser()}saveAccounts(e){localStorage.setItem("accounts",JSON.stringify(e))}saveActiveUser(e){localStorage.setItem("activeUser",e?JSON.stringify(e):"null")}loadAccounts(){try{return JSON.parse(localStorage.getItem("accounts")??"[]")}catch{return[]}}loadActiveUser(){try{return JSON.parse(localStorage.getItem("activeUser")??"null")}catch{return null}}authorizationHeader(){return l(this,null,function*(){let e=this.auth.currentUser;return e?`Bearer ${yield e.getIdToken(!0)}`:null})}linkGoogleDrive(){return l(this,null,function*(){let e=yield this.authorizationHeader();if(!e)throw new Error("User not authenticated with Firebase.");return new Promise((t,r)=>{try{google.accounts.oauth2.initCodeClient({client_id:this.GSI_CLIENT_ID,scope:"https://www.googleapis.com/auth/drive.file",ux_mode:"popup",callback:s=>l(this,null,function*(){let{code:a}=s,c=yield fetch("http://localhost:8081/mbe-mutli-media/api/google/exchange-code",{method:"POST",headers:{"Content-Type":"application/json",Authorization:e},body:JSON.stringify({authorizationCode:a})});if(!c.ok){let i=yield c.text();throw new Error(`Backend code exchange failed: ${i}`)}console.log("Google Drive linked successfully!"),t()}),error_callback:s=>{console.error("GSI Error:",s),r(new Error("Google Sign-In failed."))}}).requestCode()}catch(o){r(o)}})})}static \u0275fac=function(t){return new(t||n)};static \u0275prov=f.\u0275\u0275defineInjectable({token:n,factory:n.\u0275fac,providedIn:"root"})};export{l as a,U as b};
